<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout_frame}" xmlns="http://www.w3.org/1999/html">


<div layout:fragment="content">
    <div class="page-header align-items-start min-vh-50 pt-5 pb-11 m-3 border-radius-lg">
        <span class="mask bg-gradient-dark opacity-6"></span>
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-5 text-center mx-auto">
                    <h1 class="text-white mb-2 mt-5">Welcome!</h1>
                </div>
            </div>

            <div class="row  justify-content-center">
                <div class="col-xl-4 col-lg-5 col-md-7 mx-auto">
                    <div class="card z-index-0">
                        <div class="card-header text-center pt-4">
                            <h5>Register</h5>
                        </div>
                        <div class="card-body">
                            <form id="signUpForm" role="form" th:action="@{/sign_up}" method="POST">
                                <div class="mb-3">
                                    <input name="accountName" type="text" class="form-control" placeholder="Account Name" aria-label="Name">
                                </div>
                                <div class="mb-3">
                                    <input name="password" type="password" class="form-control" placeholder="Password" aria-label="Password">
                                </div>
                                <div class="mb-3">
                                    <input type="password" class="form-control" placeholder="Re-enter Password" aria-label="Re-enter Password">
                                </div>
                                <div class="text-center">
                                    <button onclick="signUp()" type="submit" class="btn bg-gradient-dark w-100 my-4 mb-2">Sign up</button>
                                </div>
                                <p class="text-sm mt-3 mb-0">Already have an account? <a th:href="@{/sign_in}" class="text-dark font-weight-bolder">Sign in</a></p>
                            </form>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </div>
<script>
    function signUp()
    {
        // 디폴트 submit 방지
        const formEl = document.getElementById('signUpForm');
        formEl.addEventListener('submit', (event) => {
            event.preventDefault()
        })

        const inputEl = formEl.querySelectorAll("input")
        const passEl = formEl.querySelectorAll('input[type="password"]')

        if (checkNodeNotEmpty(inputEl) )
        {
            if(passwordCheck(passEl))
            {
                saveAccount(formEl);
            }
            else
            {
                alert("패스워드가 불일치합니다")
            }
        }
        else
        {
            alert("값을 채워주세요")
        }

    }


    function saveAccount(formEl)
    {
        const formData = new FormData(formEl)

        let xhr = new XMLHttpRequest()
        xhr.open(formEl.method, formEl.action, true)

        xhr.onload = (() => {
            if ( xhr.status == 200 )
            {
                if( xhr.response == 'true')
                {
                    alert("가입을 축하드립니다")
                    location.href = "/sign_in"
                }
                else
                {
                    alert("중복 계정입니다")
                }
            }
            else
            {
                alert('이상 응답', xhr, xhr.statusText, xhr.responseText)
            }
        })

        xhr.onerror = (() => {
            alert('온 에러 ', xhr.status, xhr.statusText, xhr.responseText)
        })

        xhr.send(formData)
    }


    // 패스워드 일치 체크
    function passwordCheck(passEl)
    {
        if( passEl[0]?.value == passEl[1]?.value)
        {
            return true
        }
        else
        {
            return false
        }
    }


    // 빈값 체크
    function checkNodeNotEmpty(nodeEl) {

        for (const el of nodeEl)
        {
            if(el.value=='')
            {
                return false
            }
        }
        return true
    }

</script>
</div>


</html>
