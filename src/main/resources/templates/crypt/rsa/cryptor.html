<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout_frame}" xmlns="http://www.w3.org/1999/html">


<div class="row justify-content-md-center" layout:fragment="content">

    <div class="col-md-5 mt-4">
        <div class="card text-center">
            <div class="card-header pb-0 px-3 ">
                <h6 class="mb-0">RSA 암호화</h6>
            </div>

            <form id="form_enc" name="dtoListTest" action="/crypt/rsa/enc" method="post" enctype="multipart/form-data" target="iframe1">
                <div class="card-body pt-4 p-3 px-4">
                    <ul class="list-group align-items-center">
                        <li class="list-group-item border-0 d-flex p-4 mb-2 bg-gray-100 border-radius-lg">
                            <div class="d-flex flex-column">
                                <div class="input-group mb-3 d-flex flex-column">
                                    <textarea class="input-group-text border-end-md d-inline-block upload text-md-start" name="targetData" placeholder="암호화할 평문 데이터를 입력하세요 " ></textarea>
                                </div>
                                <div class="input-group mb-3">
                                    <span class="input-group-text text-xs  text-bold text-bg-light">공개키</span>
                                    <input class="upload form-control" type="file" name="file1"/>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
                <div class="card-footer">
                    <button class="btn btn-outline-primary" type="submit" onclick="javascript:checkBeforeUpload(this)">
                        암호화
                    </button>
                    <div id="encResultDiv" class="input-group mb-3 d-flex flex-column">
                        <p class="text-xs text-bold text-center mb-2 opacity-4" >결과</p>
                        <textarea id="encResult" class="result input-group-text border-0 visually-hidden" readonly></textarea>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="col-md-5 mt-4">
        <div class="card text-center">
            <div class="card-header pb-0 px-3 ">
                <h6 class="mb-0">RSA 복호화</h6>
            </div>

            <form id="form_dec" name="dtoListTest" action="/crypt/rsa/dec" method="post" enctype="multipart/form-data" target="iframe1">
                <div class="card-body pt-4 p-3 px-4">
                    <ul class="list-group align-items-center">
                        <li class="list-group-item border-0 d-flex p-4 mb-2 bg-gray-100 border-radius-lg">
                            <div class="d-flex flex-column">
                                <div class="input-group mb-3 d-flex flex-column">
                                    <textarea class="input-group-text border-end-md d-inline-block upload text-md-start" name="targetData" placeholder="복호화할 암호문을 입력하세요 " ></textarea>
                                </div>
                                <div class="input-group mb-3 ">
                                    <span class="input-group-text text-xs  text-bold text-bg-light">개인키</span>
                                    <input class="upload form-control col-auto" type="file" name="file1"/>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
                <div class="card-footer">
                    <button class="btn btn-outline-primary" type="submit" onclick="javascript:checkBeforeUpload(this)">
                        복호화
                    </button>
                    <div id="decResultDiv" class="input-group mb-3 d-flex flex-column">
                        <p class="text-xs text-bold text-center mb-2 opacity-4" >결과</p>
                        <textarea id="decResult" class="result input-group-text border-0 visually-hidden" readonly></textarea>
                    </div>
                </div>
            </form>
        </div>

    </div>


    <script>

        // 파일 업로드 후 머지하여 다운로드
        function uploadFiles(formEl)
        {
            const formData = new FormData(formEl)
            let resultArea = formEl.getElementsByClassName(['result'])[0]

            fetch(formEl.action, {
                method: formEl.method,
                body: formData
            }).then(response => {
                if( response.ok )
                {
                    return response.text()
                }
                else
                {
                    console.log(response)
                    alert('처리 실패')
                }
            }).then(res => {
                console.log(res)
                resultArea.classList.remove('visually-hidden');
                resultArea.textContent=res
            })
                .catch(err => {
                console.log('err', err)
            })
        }


        // 파일 업로드 전 처리 로직 (빈 파일 칸 검증 / 객체 List로 받기 위한 순서 세팅 )
        function checkBeforeUpload(ele)
        {
            const formEl = ele.closest('form')
            // 디폴트 submit 방지
            formEl.addEventListener('submit', (event) => {
                event.preventDefault()
            })

            const upEl = formEl.querySelectorAll('.upload')

            for (let i = 0; i < upEl.length; i++)
            {
                let l = upEl[i]
                // 하나라도 비어있는 파일 선택칸이 있다면
                if (!checkNodeNotEmpty(l))
                {
                    alert('모든 파일 선택칸을 채워야합니다 ')
                    return false
                }
            }

            // 파일 업로드
            uploadFiles(formEl)
        }

        // 파일 선택칸이 비어있는지 확인
        function checkNodeNotEmpty(el)
        {
            if (el.value == '')
            {
                return false
            }

            return true
        }


    </script>
    <iframe id="iframe1" name="iframe1" style="display: none"></iframe>
</div>


</html>